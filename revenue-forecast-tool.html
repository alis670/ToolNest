<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Revenue Forecast Tool — ToolNest</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#2563eb;
  --success:#10b981; --danger:#ef4444; --radius:10px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0f172a;padding:18px}
.app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
h1{margin:0;font-size:18px}
small.muted{color:var(--muted)}
input,select,button,textarea{font-family:inherit}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fff}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn{font-weight:700}
.primary{background:var(--accent);color:#fff}
.ghost{background:#f1f5f9;border:1px solid #e6eef8}
.danger{background:var(--danger);color:#fff}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.kpi{background:#fbfdff;padding:12px;border-radius:8px;text-align:center}
.kpi h3{margin:0;font-size:13px}
.kpi p{margin:6px 0 0;font-weight:800}
.table{margin-top:12px;overflow:auto;border-radius:8px;border:1px solid #eef2ff}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:#fbfdff;position:sticky;top:0}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
canvas{background:#fff;border-radius:8px;padding:8px}
.audit{margin-top:12px;max-height:180px;overflow:auto;font-size:13px;color:var(--muted)}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
label{display:block;margin-bottom:6px;font-weight:600}
@media (max-width:1000px){ .app{grid-template-columns:1fr} .kpis{grid-template-columns:repeat(2,1fr)} .charts{grid-template-columns:1fr} }
</style>
</head>
<body>

<div class="app">
  <!-- MAIN -->
  <div class="card">
    <div class="header">
      <div>
        <h1>Revenue Forecast Tool</h1>
        <small class="muted">Add revenue streams and project monthly forecasts. Pick base currency to unify reporting.</small>
      </div>

      <div style="min-width:180px">
        <small class="muted">Base currency</small>
        <select id="baseCurrency" style="width:100%;padding:8px;border-radius:8px"></select>
      </div>
    </div>

    <!-- ADD STREAM FORM -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;align-items:end">
      <div>
        <label>Stream name</label>
        <input id="streamName" placeholder="e.g. SaaS Subscriptions">
      </div>
      <div>
        <label>Amount</label>
        <input id="streamAmount" type="number" step="0.01" min="0" placeholder="1000">
      </div>
      <div>
        <label>Currency</label>
        <select id="streamCurrency"></select>
      </div>
      <div>
        <label>Frequency</label>
        <select id="streamFreq"><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="yearly">Yearly</option><option value="one-time">One-time</option></select>
      </div>
      <div>
        <label>Start date</label>
        <input id="streamStart" type="date">
      </div>
      <div style="display:flex;gap:8px;align-items:end;flex-wrap:wrap">
        <button id="addStreamBtn" class="btn primary">Add stream</button>
        <button id="clearStreamBtn" class="btn ghost">Clear</button>
      </div>
    </div>

    <!-- SCENARIO & FORECAST SETTINGS -->
    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;align-items:end">
      <div>
        <label>Projection months</label>
        <input id="projMonths" type="number" min="1" max="60" value="12">
      </div>
      <div>
        <label>Scenario growth %</label>
        <input id="scenarioPct" type="number" step="0.1" value="0">
      </div>
      <div>
        <label>Apply scenario to</label>
        <select id="scenarioApply"><option value="all">All streams</option><option value="recurring">Only recurring</option></select>
      </div>
      <div style="display:flex;gap:8px;align-items:end">
        <button id="runForecast" class="btn primary">Run Forecast</button>
        <button id="resetForecast" class="btn ghost">Reset</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><h3>Monthly MRR (base)</h3><p id="kpiMRR">0</p></div>
      <div class="kpi"><h3>Annualized Revenue (base)</h3><p id="kpiARR">0</p></div>
      <div class="kpi"><h3>Projected (months)</h3><p id="kpiProjTotal">0</p></div>
    </div>

    <!-- STREAMS TABLE -->
    <div class="table">
      <table>
        <thead>
          <tr>
            <th>Stream</th><th>Amount</th><th>Curr</th><th>Freq</th><th>Start</th><th>Converted</th><th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="streamsTbody"></tbody>
      </table>
    </div>

    <!-- CHARTS -->
    <div class="charts">
      <canvas id="stackChart" height="220"></canvas>
      <canvas id="cumChart" height="220"></canvas>
    </div>

    <!-- EXPORT / AUDIT -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;flex-wrap:wrap">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="exportCsv" class="btn ghost">Export CSV</button>
        <button id="exportJson" class="btn ghost">Export JSON</button>
        <input id="importFile" type="file" accept=".json" style="display:none">
        <button id="importBtn" class="btn ghost">Import JSON</button>
      </div>
      <div style="text-align:right">
        <button onclick="goToDashboard()" class="btn ghost">⬅ Back to Dashboard</button>
      </div>
    </div>

    <div class="audit" id="auditLog"></div>
  </div>

  <!-- SIDEBAR -->
  <div class="card">
    <h3 style="margin:0 0 8px">Forecast Summary</h3>
    <div id="summary" class="audit">No forecast run yet.</div>
  </div>
</div>

<script src="loadCurrencies.js"></script>
<script>
/* ---------- State ---------- */
const STORAGE_KEY = 'tn_rev_forecast_v1';
let streams = []; // {id, name, amount, currency, freq, start}
let rateCache = {};
let stackChart, cumChart;

/* DOM refs */
const baseCurrencyEl = document.getElementById('baseCurrency');
const streamCurrencyEl = document.getElementById('streamCurrency');

/* helpers */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(streams)); }
function load(){ streams = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }

/* wait for populateCurrencyDropdown */
async function waitForPopulate(timeout=3000){
  const start=Date.now();
  while(Date.now()-start<timeout){
    if(typeof populateCurrencyDropdown==='function') return true;
    await new Promise(r=>setTimeout(r,100));
  }
  return false;
}

/* init currencies */
(async function initCurrencies(){
  const ok = await waitForPopulate(3000);
  if(ok){
    populateCurrencyDropdown('baseCurrency');
    populateCurrencyDropdown('streamCurrency');
    setTimeout(()=>{ if(!baseCurrencyEl.value) baseCurrencyEl.value='USD'; renderAll(); },200);
  } else {
    const o = document.createElement('option'); o.value='USD'; o.text='USD'; baseCurrencyEl.appendChild(o); streamCurrencyEl.appendChild(o.cloneNode(true));
    renderAll();
  }
})();

/* fetch rates */
async function fetchRates(base='USD'){
  if(rateCache[base] && (Date.now()-rateCache[base].ts < 1000*60*15)) return rateCache[base].rates;
  try{
    const res = await fetch(`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}`);
    const data = await res.json();
    rateCache[base] = { ts: Date.now(), rates: data.rates || {} };
    return rateCache[base].rates;
  }catch(e){ console.warn('rates fail', e); return {}; }
}

/* convert amount in 'from' to base */
async function convertToBase(amount, from, base){
  if(!from || !base) return amount;
  if(from === base) return amount;
  const rates = await fetchRates(base);
  const r = rates[from];
  if(!r || r === 0) return amount;
  return amount / r;
}

/* Add stream */
document.getElementById('addStreamBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('streamName').value.trim();
  const amount = parseFloat(document.getElementById('streamAmount').value) || 0;
  const currency = streamCurrencyEl.value || (baseCurrencyEl.value || 'USD');
  const freq = document.getElementById('streamFreq').value;
  const start = document.getElementById('streamStart').value || new Date().toISOString().slice(0,10);

  if(!name || amount<=0){ alert('Name and positive amount required'); return; }

  streams.unshift({ id: uid(), name, amount, currency, freq, start });
  save(); logAudit(`Added stream ${name} ${amount} ${currency} (${freq})`);
  await renderAll();
  // clear
  document.getElementById('streamName').value=''; document.getElementById('streamAmount').value=''; document.getElementById('streamStart').value='';
});

/* Edit / Delete */
function deleteStream(id){ if(!confirm('Delete stream?')) return; streams = streams.filter(s=>s.id!==id); save(); renderAll(); logAudit(`Deleted stream ${id}`); }
function editStream(id){
  const s = streams.find(x=>x.id===id); if(!s) return;
  const name = prompt('Stream name', s.name); if(name===null) return;
  const amount = prompt('Amount', s.amount); if(amount===null) return;
  s.name = name; s.amount = parseFloat(amount) || s.amount;
  save(); renderAll(); logAudit(`Edited stream ${s.name}`);
}

/* Run forecast */
document.getElementById('runForecast').addEventListener('click', async ()=>{
  await renderForecast();
});
document.getElementById('resetForecast').addEventListener('click', async ()=>{
  document.getElementById('scenarioPct').value = 0;
  document.getElementById('projMonths').value = 12;
  renderAll();
});

/* Export / Import */
document.getElementById('exportJson').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(streams,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='revenue_streams.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('exportCsv').addEventListener('click', ()=> {
  const hdr = 'id,name,amount,currency,freq,start\n';
  const lines = streams.map(s=>`${s.id},"${s.name.replace(/"/g,'""')}",${s.amount},${s.currency},${s.freq},${s.start}`);
  const blob = new Blob([hdr + lines.join('\n')], { type:'text/csv' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='revenue_streams.csv'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const data = JSON.parse(r.result);
      if(!Array.isArray(data)) return alert('Invalid JSON');
      streams = data.concat(streams);
      save(); renderAll(); alert('Imported');
    } catch(err){ alert('Import error: '+err.message); }
  };
  r.readAsText(f); e.target.value='';
});

/* Render list + KPIs */
async function renderAll(){
  const base = baseCurrencyEl.value || 'USD';
  const rates = await fetchRates(base);

  // compute converted value for each stream for single unit (i.e., amount as provided) -> converted monthly contribution
  for(const s of streams){
    if(!s.currency) s.currency = base;
    if(s.currency === base){ s.converted = s.amount; }
    else {
      const r = rates[s.currency];
      s.converted = r && r!==0 ? s.amount / r : s.amount;
    }
  }

  // fill table
  const tbody = document.getElementById('streamsTbody');
  tbody.innerHTML = streams.map(s=>{
    return `<tr>
      <td>${escapeHtml(s.name)}</td>
      <td>${fmt(s.amount)}</td>
      <td>${escapeHtml(s.currency)}</td>
      <td>${escapeHtml(s.freq)}</td>
      <td>${s.start}</td>
      <td>${fmt(s.converted)} ${base}</td>
      <td style="text-align:right">
        <button class="btn ghost" onclick="editStream('${s.id}')">Edit</button>
        <button class="btn danger" onclick="deleteStream('${s.id}')">Delete</button>
      </td>
    </tr>`;
  }).join('');

  // quick KPIs: MRR (sum of monthly equivalents), ARR, proj total
  const monthlyValues = streams.map(s=> freqToMonthly(s.converted, s.freq) );
  const MRR = monthlyValues.reduce((a,b)=>a+b,0);
  const months = parseInt(document.getElementById('projMonths').value)||12;
  const scenarioPct = parseFloat(document.getElementById('scenarioPct').value)||0;
  const applyTo = document.getElementById('scenarioApply').value;

  // compute projected series
  const forecast = await buildForecast(months, scenarioPct, applyTo, base);
  const projTotal = forecast.netSeries.reduce((a,b)=>a+b,0);

  document.getElementById('kpiMRR').innerText = `${fmt(MRR)} ${base}`;
  document.getElementById('kpiARR').innerText = `${fmt(MRR*12)} ${base}`;
  document.getElementById('kpiProjTotal').innerText = `${fmt(projTotal)} ${base}`;

  // charts: show last X months (labels from forecast) and stacked by streams
  renderStackChart(forecast.labels, forecast.byStream, base);
  renderCumChart(forecast.labels, forecast.cumulative, base);

  // summary
  document.getElementById('summary').innerHTML = `<div>Projection: ${months} months • Scenario: ${scenarioPct}% applied to ${applyTo}</div>
    <div style="margin-top:8px">Total projected revenue: <strong>${fmt(projTotal)} ${base}</strong></div>`;
}

/* freq conversion helper: convert amount per freq to monthly equivalent */
function freqToMonthly(amount, freq){
  if(freq === 'monthly') return amount;
  if(freq === 'quarterly') return amount / 3;
  if(freq === 'yearly') return amount / 12;
  if(freq === 'one-time') return amount; // treat one-time as single month (user decides)
  return amount;
}

/* build forecast: returns { labels[], byStream: [{label, data[] }], netSeries[], cumulative[] } */
async function buildForecast(months=12, scenarioPct=0, applyTo='all', base='USD'){
  const rates = await fetchRates(base);
  const labels = [];
  const start = new Date();
  for(let i=1;i<=months;i++){
    const d = new Date(start.getFullYear(), start.getMonth()+i, 1);
    labels.push(d.toISOString().slice(0,7));
  }

  // prepare per-stream monthly contributions across the months
  const byStream = [];
  const netSeries = new Array(months).fill(0);
  for(const s of streams){
    const arr = new Array(months).fill(0);
    // monthly equivalent
    const monthly = freqToMonthly(s.converted, s.freq);
    // start month index
    const sIdx = (()=>{ const sd = new Date(s.start); const monthsDiff = (start.getFullYear()-sd.getFullYear())*12 + (start.getMonth()-sd.getMonth()); return Math.max(0, -monthsDiff); })();
    // simpler: we'll assume stream applies from its start if start <= future month
    for(let m=0;m<months;m++){
      // compare label to start
      const label = labels[m] + '-01';
      if(new Date(s.start) <= new Date(label)){
        arr[m] = monthly;
      }
    }
    // apply scenario if needed
    const applyScenario = (applyTo === 'all') || (applyTo === 'recurring' && s.freq !== 'one-time');
    if(applyScenario && scenarioPct){
      for(let m=0;m<months;m++){
        // apply monthly compounded growth across months relative to month 0
        const growthFactor = Math.pow(1 + (scenarioPct/100), m/12); // annualized smoothing
        arr[m] = arr[m] * growthFactor;
      }
    }
    // accumulate
    for(let m=0;m<months;m++) netSeries[m] += arr[m];
    byStream.push({ label: s.name, data: arr });
  }

  // cumulative
  const cumulative = [];
  let cum = 0;
  for(let m=0;m<months;m++){ cum += netSeries[m]; cumulative.push(cum); }

  return { labels, byStream, netSeries, cumulative };
}

/* Charts rendering */
function renderStackChart(labels, byStream, base){
  const ctx = document.getElementById('stackChart').getContext('2d');
  if(stackChart) stackChart.destroy();
  const datasets = byStream.map((s,i)=>({ label: s.label, data: s.data, stack: 'stack1' }));
  stackChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
  });
}
function renderCumChart(labels, cumulative, base){
  const ctx = document.getElementById('cumChart').getContext('2d');
  if(cumChart) cumChart.destroy();
  cumChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:'Cumulative Revenue', data:cumulative, borderColor:'#2563eb', fill:true, backgroundColor:'rgba(37,99,235,0.08)' }]},
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
}

/* helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function logAudit(msg){ const el = document.getElementById('auditLog'); el.innerHTML = `<div style="padding:6px;border-bottom:1px solid #f1f5f9"><small>${new Date().toISOString().slice(0,19).replace('T',' ')}</small><div>${escapeHtml(msg)}</div></div>` + el.innerHTML; }

/* init + load */
(async function startup(){
  loadStreams();
  await renderAll();
})();

function loadStreams(){ streams = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }

/* go to dashboard */
function goToDashboard(){ window.location.href = 'index.html'; }
</script>
</body>
</html>
