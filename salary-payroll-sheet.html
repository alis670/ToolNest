<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Salary Payroll Sheet — Multi-Currency</title>

<!-- Chart.js for KPIs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#2563eb;
  --success:#10b981; --danger:#ef4444; --radius:10px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0f172a;padding:18px}
.app{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
h1{margin:0;font-size:18px}
small.muted{color:var(--muted)}
input,select,button{font-family:inherit}
input,select{padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fff;width:100%}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn{font-weight:700}
.primary{background:var(--accent);color:#fff}
.ghost{background:#f1f5f9;border:1px solid #e6eef8}
.danger{background:var(--danger);color:#fff}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.kpi{background:#fbfdff;padding:12px;border-radius:8px;text-align:center}
.kpi h3{margin:0;font-size:13px}
.kpi p{margin:6px 0 0;font-weight:800}
.table{margin-top:12px;overflow:auto;border-radius:8px;border:1px solid #eef2ff}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:#fbfdff;position:sticky;top:0}
.audit{margin-top:12px;max-height:180px;overflow:auto;font-size:13px;color:var(--muted)}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
label{display:block;margin-bottom:6px;font-weight:600}
@media (max-width:1000px){.app{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<div class="app">

  <!-- MAIN PAYROLL FORM -->
  <div class="card">
    <div class="header">
      <div>
        <h1>Salary Payroll Sheet</h1>
        <small class="muted">Enter employee salaries and select base currency for conversion.</small>
      </div>
      <div style="min-width:180px">
        <small class="muted">Base currency</small>
        <select id="baseCurrency" style="width:100%;padding:8px"></select>
      </div>
    </div>

    <!-- Form -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;align-items:end">
      <div><label>Employee Name</label><input id="employeeName" placeholder="John Doe"></div>
      <div><label>Salary</label><input id="salaryAmount" type="number" min="0" step="0.01"></div>
      <div><label>Currency</label><select id="salaryCurrency"></select></div>
      <div><label>Department</label><input id="department" placeholder="e.g. IT"></div>
      <div><label>Payment Type</label>
        <select id="paymentType"><option>Monthly</option><option>Weekly</option><option>One-time</option></select>
      </div>
      <div><label>Date</label><input id="salaryDate" type="date"></div>
      <div style="display:flex;align-items:end;gap:8px;flex-wrap:wrap">
        <button id="addSalaryBtn" class="btn primary">Add</button>
        <button id="clearSalaryBtn" class="btn ghost">Clear</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><h3>Total Payroll</h3><p id="kpiTotalPayroll">0</p></div>
      <div class="kpi"><h3>Average Salary</h3><p id="kpiAvgSalary">0</p></div>
      <div class="kpi"><h3>Highest Salary</h3><p id="kpiMaxSalary">0</p></div>
    </div>

    <!-- Table -->
    <div class="table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Salary</th>
            <th>Curr</th>
            <th>Department</th>
            <th>Payment Type</th>
            <th>Date</th>
            <th>Converted</th>
            <th style="text-align:right">Actions</th>
          </tr>
        </thead>
        <tbody id="salaryTableBody"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <div class="audit" id="auditLog"></div>
      <div style="text-align:right">
        <button onclick="goToDashboard()" class="btn ghost">⬅ Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="card" style="display:flex;flex-direction:column;gap:12px;">
    <h3 style="margin:0 0 8px">Department Summary</h3>
    <div id="departmentSummary" class="audit"></div>
  </div>

</div>

<script src="loadCurrencies.js"></script>
<script>
let salaryEntries=[], rateCache={};
const baseCurrencyEl=document.getElementById('baseCurrency');
const salaryCurrencyEl=document.getElementById('salaryCurrency');

/* Utils */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function nowISO(){ return new Date().toISOString().slice(0,19).replace('T',' '); }
function saveAll(){ localStorage.setItem('payroll_entries',JSON.stringify(salaryEntries)); }
function loadAll(){ salaryEntries=JSON.parse(localStorage.getItem('payroll_entries')||'[]'); }

/* Populate currencies */
async function waitForPopulate(timeout=3000){
  const start=Date.now();
  while(Date.now()-start<timeout){
    if(typeof populateCurrencyDropdown==='function') return true;
    await new Promise(r=>setTimeout(r,100));
  }
  return false;
}

(async function initBaseCurrency(){
  const ok=await waitForPopulate(3000);
  if(ok){
    populateCurrencyDropdown('baseCurrency');
    populateCurrencyDropdown('salaryCurrency');
    setTimeout(()=>{if(!baseCurrencyEl.value) baseCurrencyEl.value='USD'; renderAll();},200);
  } else {
    const o=document.createElement('option'); o.value='USD'; o.text='USD'; baseCurrencyEl.appendChild(o);
    salaryCurrencyEl.appendChild(o.cloneNode(true));
    renderAll();
  }
})();

/* Fetch rates */
async function fetchRates(base='USD'){
  if(rateCache[base] && (Date.now()-rateCache[base].ts<1000*60*15)) return rateCache[base].rates;
  try{
    const res=await fetch(`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}`);
    const data=await res.json();
    rateCache[base]={ts:Date.now(),rates:data.rates||{}};
    return rateCache[base].rates;
  }catch(e){console.warn('rates fail',e); return {};}
}

/* Add salary */
document.getElementById('addSalaryBtn').addEventListener('click',async ()=>{
  const name=document.getElementById('employeeName').value.trim();
  const amount=parseFloat(document.getElementById('salaryAmount').value);
  const currency=salaryCurrencyEl.value;
  const dept=document.getElementById('department').value.trim();
  const type=document.getElementById('paymentType').value;
  const date=document.getElementById('salaryDate').value || new Date().toISOString().slice(0,10);

  if(!name||!amount){ alert('Name and Salary are required'); return; }

  const entry={id:uid(),name,amount,currency,dept,type,date,converted:0};
  salaryEntries.unshift(entry);
  saveAll();
  logAudit(`Added salary: ${name} ${amount} ${currency}`);
  await renderAll();
  document.getElementById('employeeName').value=''; document.getElementById('salaryAmount').value=''; document.getElementById('department').value=''; document.getElementById('salaryDate').value='';
});

/* Delete/Edit */
function deleteSalary(id){ salaryEntries=salaryEntries.filter(e=>e.id!==id); saveAll(); renderAll(); logAudit(`Deleted salary ${id}`);}
function editSalary(id){
  const e=salaryEntries.find(x=>x.id===id); if(!e) return;
  const newName=prompt('Employee Name',e.name); if(newName===null) return;
  const newAmt=prompt('Salary Amount',e.amount); if(newAmt===null) return;
  e.name=newName; e.amount=parseFloat(newAmt)||e.amount;
  saveAll(); logAudit(`Edited salary ${id}`); renderAll();
}

/* Render Table & KPIs */
async function renderAll(){
  const base=baseCurrencyEl.value||'USD';
  const rates=await fetchRates(base);

  for(const e of salaryEntries){
    if(!e.currency) e.currency=base;
    if(e.currency===base){ e.converted=e.amount; }
    else{ const r=rates[e.currency]; e.converted=r&&r!==0?e.amount/r:e.amount; }
  }

  // Table
  const tbody=document.getElementById('salaryTableBody');
  tbody.innerHTML=salaryEntries.map(e=>`<tr>
    <td>${e.name}</td>
    <td>${fmt(e.amount)}</td>
    <td>${e.currency}</td>
    <td>${e.dept}</td>
    <td>${e.type}</td>
    <td>${e.date}</td>
    <td>${fmt(e.converted)} ${base}</td>
    <td style="text-align:right">
      <button onclick="editSalary('${e.id}')" class="btn ghost">Edit</button>
      <button onclick="deleteSalary('${e.id}')" class="btn danger">Delete</button>
    </td>
  </tr>`).join('');

  // KPIs
  const total=salaryEntries.reduce((a,b)=>a+b.converted,0);
  const avg=salaryEntries.length?total/salaryEntries.length:0;
  const max=salaryEntries.length?Math.max(...salaryEntries.map(e=>e.converted)):0;
  document.getElementById('kpiTotalPayroll').innerText=fmt(total)+' '+base;
  document.getElementById('kpiAvgSalary').innerText=fmt(avg)+' '+base;
  document.getElementById('kpiMaxSalary').innerText=fmt(max)+' '+base;

  // Department summary
  const summary={};
  salaryEntries.forEach(e=>{ if(!summary[e.dept]) summary[e.dept]=0; summary[e.dept]+=e.converted; });
  document.getElementById('departmentSummary').innerHTML=Object.entries(summary).map(([d,v])=>`<div>${d}: ${fmt(v)} ${base}</div>`).join('') || '<div>No data</div>';
}

/* Audit */
function logAudit(msg){ const audit=document.getElementById('auditLog'); audit.innerHTML=`<div>${nowISO()}: ${msg}</div>`+audit.innerHTML; }

/* Back to dashboard */
function goToDashboard(){ window.location.href='index.html'; }

/* Load saved entries */
loadAll();
renderAll();
</script>

</body>
</html>
