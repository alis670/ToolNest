<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cash Flow Analyzer | ToolNest</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #f4f6f8;
  padding: 15px;
  margin: 0;
}
.container {
  max-width: 600px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  margin-bottom: 15px;
  color: #222;
}
.section-title {
  margin-top: 15px;
  font-weight: 600;
  color: #333;
}
.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}
input, select {
  flex: 1 1 45%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 15px;
}
button {
  padding: 10px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  width: 100%;
}
button:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 14px;
}
.summary {
  background: #f1f3f5;
  padding: 12px;
  border-radius: 10px;
  margin-top: 15px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
}
canvas {
  margin-top: 20px;
  width: 100%;
  height: 250px;
}
.back-btn {
  background: #6c757d;
  margin-top: 20px;
}
.back-btn:hover {
  background: #565e64;
}
@media (max-width: 480px) {
  input, select {
    flex: 1 1 100%;
  }
}
</style>
</head>
<body>

<div class="container">
  <h1>ðŸ’° Cash Flow Analyzer</h1>

  <div class="section-title">Add Transaction</div>
  <div class="form-row">
    <input type="text" id="desc" placeholder="Description">
    <input type="number" id="amount" placeholder="Amount">
  </div>
  <div class="form-row">
    <select id="type">
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <select id="currency"></select>
  </div>
  <div class="form-row">
    <input type="month" id="month">
    <button onclick="addTransaction()">Add</button>
  </div>

  <table id="cashFlowTable">
    <thead>
      <tr>
        <th>Description</th>
        <th>Amount</th>
        <th>Type</th>
        <th>Currency</th>
        <th>Month</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary">
    Net Cash Flow: <span id="netFlow">0.00</span>
  </div>

  <canvas id="cashChart"></canvas>

  <div style="text-align:center; margin-top:10px;">
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="clearAll()">Clear All</button>
    <button class="back-btn" onclick="goToDashboard()">â¬… Back to Dashboard</button>
  </div>
</div>

<script src="loadCurrencies.js"></script>
<script>
populateCurrencyDropdown('currency');

let transactions = [];
let chart;

function addTransaction() {
  const desc = document.getElementById('desc').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const type = document.getElementById('type').value;
  const currency = document.getElementById('currency').value;
  const month = document.getElementById('month').value;

  if (!desc || !amount || !currency || !month) {
    alert("Please fill all fields correctly.");
    return;
  }

  transactions.push({ desc, amount, type, currency, month });
  renderTable();
  updateSummary();
  updateChart();

  document.getElementById('desc').value = '';
  document.getElementById('amount').value = '';
}

function renderTable() {
  const tbody = document.querySelector("#cashFlowTable tbody");
  tbody.innerHTML = '';
  transactions.forEach((t, i) => {
    const row = `<tr>
      <td>${t.desc}</td>
      <td>${t.amount.toFixed(2)}</td>
      <td>${t.type}</td>
      <td>${t.currency}</td>
      <td>${t.month}</td>
      <td><button onclick="deleteTransaction(${i})" style="background:#dc3545;">X</button></td>
    </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

function deleteTransaction(i) {
  transactions.splice(i, 1);
  renderTable();
  updateSummary();
  updateChart();
}

function updateSummary() {
  const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
  const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const net = income - expense;
  const netFlow = document.getElementById('netFlow');
  netFlow.textContent = net.toFixed(2);
  netFlow.style.color = net >= 0 ? 'green' : 'red';
}

function updateChart() {
  const months = [...new Set(transactions.map(t => t.month))];
  const incomeData = months.map(m => transactions.filter(t => t.type === 'income' && t.month === m).reduce((sum, t) => sum + t.amount, 0));
  const expenseData = months.map(m => transactions.filter(t => t.type === 'expense' && t.month === m).reduce((sum, t) => sum + t.amount, 0));

  const ctx = document.getElementById('cashChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: 'Income', data: incomeData, backgroundColor: '#28a745' },
        { label: 'Expenses', data: expenseData, backgroundColor: '#dc3545' }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function downloadCSV() {
  if (transactions.length === 0) {
    alert("No data to download.");
    return;
  }

  let csv = "Description,Amount,Type,Currency,Month\n";
  transactions.forEach(t => {
    csv += `${t.desc},${t.amount},${t.type},${t.currency},${t.month}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "CashFlow_Analyzer.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function clearAll() {
  if (confirm("Clear all transactions?")) {
    transactions = [];
    renderTable();
    updateSummary();
    updateChart();
  }
}

function goToDashboard() {
  window.location.href = "index.html";
}
</script>
</body>
</html>
