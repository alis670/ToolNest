<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Expense Tracker â€” Single Base Currency</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#2563eb;
  --success:#10b981; --danger:#ef4444; --radius:10px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0f172a;padding:18px}
.app{max-width:1150px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
.card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
h1{margin:0;font-size:18px}
small.muted{color:var(--muted)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea,button{font-family:inherit}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fff}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn{font-weight:700}
.primary{background:var(--accent);color:#fff}
.ghost{background:#f1f5f9;border:1px solid #e6eef8}
.danger{background:var(--danger);color:#fff}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.kpi{background:#fbfdff;padding:12px;border-radius:8px;text-align:center}
.kpi h3{margin:0;font-size:13px}
.kpi p{margin:6px 0 0;font-weight:800}
.table{margin-top:12px;overflow:auto;border-radius:8px;border:1px solid #eef2ff}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
th{background:#fbfdff;position:sticky;top:0}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
canvas{background:#fff;border-radius:8px;padding:8px}
.audit{margin-top:12px;max-height:180px;overflow:auto;font-size:13px;color:var(--muted)}
@media (max-width:1000px){ .app{grid-template-columns:1fr} .kpis{grid-template-columns:repeat(2,1fr)} .charts{grid-template-columns:1fr} }
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff3f2;color:var(--danger);font-weight:700}
label{display:block;margin-bottom:6px;font-weight:600}
.readonly { background:#f8fafc; color:#0b1220; }
</style>
</head>
<body>

<div class="app">

  <!-- MAIN -->
  <div class="card">
    <div class="header">
      <div>
        <h1>Expense Tracker â€” Single Base Currency</h1>
        <small class="muted">Choose one base currency â€” all sections follow it automatically.</small>
      </div>

      <div style="min-width:180px">
        <small class="muted">Base currency</small>
        <select id="baseCurrency" style="width:100%;padding:8px;border-radius:8px"></select>
      </div>
    </div>

    <!-- form -->
    <div style="display:grid;grid-template-columns:1fr 120px 120px 160px;gap:8px">
      <div>
        <label>Description</label>
        <input id="desc" placeholder="e.g. Google Workspace">
      </div>

      <div>
        <label>Amount</label>
        <input id="amount" type="number" min="0" step="0.01">
      </div>

      <!-- Entry currency removed; entries will store original currency but shown/entered as Base Currency -->
      <div>
        <label>Currency (locked)</label>
        <input id="entryCurrency" class="readonly" readonly>
      </div>

      <div>
        <label>Date</label>
        <input id="date" type="date">
      </div>

      <div>
        <label>Category</label>
        <select id="category">
          <option>Uncategorized</option><option>Software</option><option>Marketing</option><option>Salaries</option>
          <option>Hosting</option><option>Office</option><option>Travel</option><option>Other</option>
        </select>
      </div>

      <div>
        <label>Type</label>
        <select id="type"><option value="expense">Expense</option><option value="income">Income</option></select>
      </div>

      <div>
        <label>Recurring</label>
        <select id="recurring"><option value="none">None</option><option value="monthly">Monthly</option></select>
      </div>

      <div style="display:flex;align-items:end;gap:8px">
        <button id="addBtn" class="btn primary">Add</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>
    </div>

    <!-- filters (FULL DATE) -->
    <div class="filter-row" style="margin-top:12px">
      <div><label>Start date ðŸ“…</label><input id="startDate" type="date"></div>
      <div><label>End date ðŸ“…</label><input id="endDate" type="date"></div>
      <div style="min-width:160px"><label>Category</label><select id="filterCategory"><option value="">All</option><option>Uncategorized</option><option>Software</option><option>Marketing</option><option>Salaries</option><option>Hosting</option><option>Office</option><option>Travel</option><option>Other</option></select></div>
      <div style="min-width:140px"><label>Search</label><input id="searchText" placeholder="search description"></div>
      <div style="align-self:end"><button id="applyFilter" class="btn ghost">Apply</button></div>
      <div style="margin-left:auto;align-self:end;display:flex;gap:8px">
        <button id="exportCsv" class="btn ghost">Export CSV</button>
        <button id="exportJson" class="btn ghost">Export JSON</button>
        <button id="importBtn" class="btn ghost">Import JSON</button>
        <input id="importFile" type="file" accept=".json" style="display:none">
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><h3>Total Balance</h3><p id="kpiBalance">0</p></div>
      <div class="kpi"><h3>Total Income</h3><p id="kpiIncome">0</p></div>
      <div class="kpi"><h3>Total Expense</h3><p id="kpiExpense">0</p></div>
    </div>

    <!-- charts -->
    <div class="charts">
      <canvas id="monthlyChart" height="220"></canvas>
      <canvas id="categoryChart" height="220"></canvas>
    </div>

    <!-- table -->
    <div class="table" style="margin-top:12px">
      <table>
        <thead>
          <tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th style="text-align:right">Amount</th><th>Curr</th><th>Rec</th><th style="text-align:right">Actions</th></tr>
        </thead>
        <tbody id="entriesTbody"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="audit" id="auditLog"></div>
      <div style="text-align:right">
        <button onclick="goToDashboard()" class="btn ghost">â¬… Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="card">
    <h3 style="margin:0 0 8px">Budgets & Alerts</h3>

    <div>
      <label>Set monthly budget (per category)</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <select id="budgetCategory" style="flex:1"><option>Software</option><option>Marketing</option><option>Salaries</option><option>Hosting</option><option>Office</option><option>Travel</option><option>Other</option></select>
        <input id="budgetAmount" type="number" placeholder="amount" style="width:120px">
        <button id="addBudget" class="btn primary">Save</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4 style="margin:6px 0">Active Budgets (this month)</h4>
      <div id="budgetList" class="audit"></div>
    </div>

    <div style="margin-top:12px">
      <h4 style="margin:6px 0">Quick KPIs</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="background:#fbfdff;padding:8px;border-radius:8px;text-align:center"><div class="muted">Avg Monthly Expense</div><div id="avgMonthly">0</div></div>
        <div style="background:#fbfdff;padding:8px;border-radius:8px;text-align:center"><div class="muted">Highest Category</div><div id="topCategory">-</div></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <h4 style="margin:6px 0">Recent Alerts</h4>
      <div id="alerts" class="audit"></div>
    </div>
  </div>

</div>

<script src="loadCurrencies.js"></script>
<script>
/* ---------- Storage & state ---------- */
const STORAGE_KEY = 'et_pro_v3_entries';
const BUDGET_KEY = 'et_pro_v3_budgets';
const AUDIT_KEY = 'et_pro_v3_audit';
let entries = []; let budgets = {}; let audit = [];
let monthlyChart, categoryChart;
let rateCache = {};

/* DOM refs */
const baseCurrencyEl = document.getElementById('baseCurrency');
const entryCurrencyInput = document.getElementById('entryCurrency');
const displayCurrencyEl = document.getElementById('baseCurrency'); // same control
const currencyEl = document.getElementById('currency'); // used only for fallback population in some cases

/* helpers */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function nowISO(){ return new Date().toISOString().slice(0,19).replace('T',' '); }
function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); localStorage.setItem(BUDGET_KEY, JSON.stringify(budgets)); localStorage.setItem(AUDIT_KEY, JSON.stringify(audit.slice(0,500))); }
function loadAll(){ entries = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); budgets = JSON.parse(localStorage.getItem(BUDGET_KEY)||'{}'); audit = JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]'); }

/* wait for populateCurrencyDropdown from loadCurrencies.js */
async function waitForPopulate(timeout=3000){
  const start = Date.now();
  while(Date.now() - start < timeout){
    if(typeof populateCurrencyDropdown === 'function') return true;
    await new Promise(r=>setTimeout(r,100));
  }
  return false;
}

(async function initBaseCurrency(){
  const ok = await waitForPopulate(3000);
  if(ok){
    populateCurrencyDropdown('baseCurrency'); // populate base currency dropdown
    // set entryCurrency field to current selection
    setTimeout(()=>{ const v = baseCurrencyEl.value || 'USD'; entryCurrencyInput.value = v; renderAll(); }, 200);
  } else {
    // fallback
    const o=document.createElement('option'); o.value='USD'; o.text='USD'; baseCurrencyEl.appendChild(o);
    entryCurrencyInput.value = 'USD';
    renderAll();
  }
})();

/* rates */
async function fetchRates(base='USD'){
  if(rateCache[base] && (Date.now() - rateCache[base].ts < 1000*60*15)) return rateCache[base].rates;
  try{
    const res = await fetch(`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}`);
    const data = await res.json();
    rateCache[base] = { ts: Date.now(), rates: data.rates || {} };
    return rateCache[base].rates;
  }catch(e){ console.warn('rates fail', e); return {}; }
}

/* convert amount from originalCurrency -> baseCurrency */
async function convertToBase(amount, originalCurrency, base){
  if(!originalCurrency || !base) return amount;
  if(originalCurrency === base) return amount;
  const rates = await fetchRates(base);
  const r = rates[originalCurrency];
  if(!r || r === 0) return amount;
  return amount / r;
}

/* load/save */
loadAll();

/* audit */
function log(msg){ audit.unshift({ts: nowISO(), msg}); if(audit.length>500) audit.pop(); saveAll(); renderAudit(); }
function renderAudit(){ document.getElementById('auditLog').innerHTML = audit.slice(0,50).map(a=>`<div style="padding:6px;border-bottom:1px solid #f1f5f9"><small>${a.ts}</small><div>${a.msg}</div></div>`).join(''); }

/* add entry (entry currency is implicitly base currency, and originalCurrency is stored as base) */
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const desc = document.getElementById('desc').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const base = baseCurrencyEl.value || 'USD';
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const category = document.getElementById('category').value;
  const type = document.getElementById('type').value;
  const recurring = document.getElementById('recurring').value;
  if(!desc || !amount){ alert('Please fill description and amount.'); return; }

  // store originalAmount and originalCurrency (both equal to base on entry)
  const e = { id: uid(), desc, originalAmount: amount, originalCurrency: base, date, category, type, recurring, displayAmount: amount };
  entries.unshift(e);
  log(`Added ${type} ${amount} ${base} â€” ${desc}`);
  saveAll();
  await renderAll();
  document.getElementById('desc').value=''; document.getElementById('amount').value=''; document.getElementById('date').value='';
});

/* delete/edit */
window.deleteEntry = async function(id){
  if(!confirm('Delete this entry?')) return;
  entries = entries.filter(e=>e.id !== id);
  log(`Deleted entry ${id}`);
  saveAll(); await renderAll();
};
window.editEntry = async function(id){
  const e = entries.find(x=>x.id===id); if(!e) return;
  const newDesc = prompt('Description', e.desc); if(newDesc===null) return;
  const newAmt = prompt('Amount (in base currency)', e.originalAmount); if(newAmt===null) return;
  e.desc = newDesc; e.originalAmount = Number(newAmt) || e.originalAmount;
  saveAll(); log(`Edited entry ${id}`); await renderAll();
};

/* budgets */
document.getElementById('addBudget').addEventListener('click', ()=>{
  const cat = document.getElementById('budgetCategory').value;
  const amt = parseFloat(document.getElementById('budgetAmount').value);
  if(!cat || !amt || amt<=0){ alert('Enter valid category and amount'); return; }
  const key = `${cat}|${new Date().toISOString().slice(0,7)}`;
  budgets[key] = amt;
  log(`Budget set: ${cat} = ${amt}`);
  saveAll(); renderBudgets(); renderAlerts();
});

function renderBudgets(){
  const month = new Date().toISOString().slice(0,7);
  const rows = Object.keys(budgets).filter(k=>k.endsWith('|'+month)).map(k=>{
    const cat = k.split('|')[0]; const b = budgets[k];
    // spent uses displayAmount (already in base currency)
    const spent = entries.filter(e=>e.category===cat && e.date.slice(0,7)===month).reduce((s,x)=>s + (x.type==='expense' ? (x.displayAmount ?? x.originalAmount) : 0), 0);
    return `<div style="padding:8px;border-bottom:1px solid #f1f5f9"><strong>${cat}</strong>: ${fmt(spent)} / ${fmt(b)} ${spent>b?'<span class="badge">OVER</span>':''}</div>`;
  });
  document.getElementById('budgetList').innerHTML = rows.join('') || '<div class="muted">No budgets set for this month</div>';
}

/* filters (full date) */
function getFiltered(){
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  const cat = document.getElementById('filterCategory').value;
  const search = (document.getElementById('searchText').value||'').toLowerCase();
  return entries.filter(e=>{
    if(cat && cat !== '' && e.category !== cat) return false;
    if(start && e.date < start) return false;
    if(end && e.date > end) return false;
    if(search && !(e.desc.toLowerCase().includes(search) || (e.category||'').toLowerCase().includes(search))) return false;
    return true;
  });
}

/* renderAll: computes displayAmount for each entry (converted to base currency if needed) */
async function renderAll(){
  const base = baseCurrencyEl.value || 'USD';
  entryCurrencyInput.value = base; // show locked currency in entry field
  const rates = await fetchRates(base);

  // compute displayAmount: convert originalAmount from originalCurrency -> base
  for(const e of entries){
    // if originalCurrency equals base, displayAmount = originalAmount
    if(!e.originalCurrency) e.originalCurrency = base;
    if(e.originalCurrency === base){ e.displayAmount = e.originalAmount; }
    else {
      // convert originalAmount -> base
      const r = rates[e.originalCurrency];
      if(r && r !== 0) e.displayAmount = e.originalAmount / r;
      else e.displayAmount = e.originalAmount; // fallback
    }
  }

  renderTable();
  renderKPIs();
  await renderCharts();
  renderBudgets();
  renderAlerts();
  renderAudit();
}

/* render table */
function renderTable(){
  const list = getFiltered();
  const tbody = document.getElementById('entriesTbody');
  tbody.innerHTML = '';
  list.forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.date}</td>
      <td>${escapeHtml(e.desc)}</td>
      <td>${escapeHtml(e.category)}</td>
      <td>${escapeHtml(e.type)}</td>
      <td style="text-align:right">${fmt(e.displayAmount ?? e.originalAmount)}</td>
      <td>${escapeHtml(displayCurrencyEl.value || e.originalCurrency || 'USD')}</td>
      <td>${escapeHtml(e.recurring)}</td>
      <td style="text-align:right">
        <button class="ghost" onclick="editEntry('${e.id}')">Edit</button>
        <button class="danger" onclick="deleteEntry('${e.id}')">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* KPIs */
function renderKPIs(){
  const list = getFiltered();
  const income = list.filter(e=>e.type==='income').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0);
  const expense = list.filter(e=>e.type==='expense').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0);
  const balance = income - expense;
  const base = baseCurrencyEl.value || 'USD';
  document.getElementById('kpiIncome').innerText = `${base} ${fmt(income)}`;
  document.getElementById('kpiExpense').innerText = `${base} ${fmt(expense)}`;
  document.getElementById('kpiBalance').innerText = `${base} ${fmt(balance)}`;

  // sidebar KPIs
  const months = {};
  entries.forEach(e=> { const m = e.date.slice(0,7); months[m] = months[m] || {income:0, expense:0}; const val = e.displayAmount ?? e.originalAmount; if(e.type==='income') months[m].income += val; else months[m].expense += val; });
  const avgMonthly = Object.values(months).reduce((s,m)=>s + m.expense,0) / Math.max(1,Object.keys(months).length);
  document.getElementById('avgMonthly').innerText = `${base} ${fmt(avgMonthly)}`;
  const topCatObj = {};
  entries.forEach(e=>{ if(e.type==='expense') topCatObj[e.category] = (topCatObj[e.category]||0) + (e.displayAmount ?? e.originalAmount); });
  const topCat = Object.entries(topCatObj).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('topCategory').innerText = topCat ? `${topCat[0]} (${fmt(topCat[1])})` : '-';
}

/* charts */
async function renderCharts(){
  const list = getFiltered();
  const months = getLastNMonths(12);
  const incomeData = months.map(m=> list.filter(e=>e.date.slice(0,7)===m && e.type==='income').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0));
  const expenseData = months.map(m=> list.filter(e=>e.date.slice(0,7)===m && e.type==='expense').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0));

  if(monthlyChart) monthlyChart.destroy();
  if(categoryChart) categoryChart.destroy();

  const ctxM = document.getElementById('monthlyChart').getContext('2d');
  monthlyChart = new Chart(ctxM, {
    type:'bar',
    data:{ labels: months, datasets: [{ label:'Income', data: incomeData, backgroundColor:'#10b981' }, { label:'Expense', data: expenseData, backgroundColor:'#ef4444' }] },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } }
  });

  const catMap = {};
  list.filter(e=>e.type==='expense').forEach(e=> catMap[e.category] = (catMap[e.category]||0) + (e.displayAmount ?? e.originalAmount));
  const ctxC = document.getElementById('categoryChart').getContext('2d');
  categoryChart = new Chart(ctxC, { type:'pie', data:{ labels:Object.keys(catMap), datasets:[{ data:Object.values(catMap), backgroundColor: palette(Object.keys(catMap).length) }] }, options:{ responsive:true, plugins:{ legend:{ position:'right' } } } );
}

/* helpers */
function getLastNMonths(n){
  const arr=[]; const now=new Date();
  for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); arr.push(d.toISOString().slice(0,7)); }
  return arr;
}
function palette(n){ const p=['#ef4444','#f59e0b','#10b981','#3b82f6','#6366f1','#8b5cf6','#06b6d4','#f97316','#ef4444','#06b6d4']; return Array.from({length:n},(_,i)=>p[i%p.length]); }

/* alerts & budgets */
function renderAlerts(){
  alertsEl.innerHTML = '';
  renderBudgets();
  const month = new Date().toISOString().slice(0,7);
  Object.keys(budgets).forEach(k=>{
    const [cat,bm] = k.split('|');
    if(bm !== month) return;
    const limit = budgets[k];
    const spent = entries.filter(e=>e.category===cat && e.date.slice(0,7)===month).reduce((s,x)=>s + (x.type==='expense' ? (x.displayAmount ?? x.originalAmount) : 0), 0);
    if(spent > limit){
      alertsEl.insertAdjacentHTML('beforeend', `<div style="padding:8px;border-radius:8px;background:#fff3f2;border:1px solid #fdecea"><strong>Budget Alert:</strong> ${cat} overspent: ${fmt(spent)} / ${fmt(limit)}</div>`);
    }
  });

  const lastMonth = (()=>{ const d = new Date(); d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,7); })();
  const lastOut = entries.filter(e=>e.date.slice(0,7)===lastMonth && e.type==='expense').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0);
  const lastIn = entries.filter(e=>e.date.slice(0,7)===lastMonth && e.type==='income').reduce((s,e)=>s + (e.displayAmount ?? e.originalAmount),0);
  if(lastOut > lastIn * 1.5 && lastIn > 0){
    alertsEl.insertAdjacentHTML('beforeend', `<div style="padding:8px;border-radius:8px;background:#fff7ed;border:1px solid #ffedd5"><strong>Warning:</strong> Last month's outflow ${fmt(lastOut)} exceeds 150% of inflow ${fmt(lastIn)}</div>`);
  }
}

/* export/import */
document.getElementById('exportCsv').addEventListener('click', ()=> {
  const base = baseCurrencyEl.value || 'USD';
  const hdr = `date,desc,category,type,amount_in_base_currency,base_currency,recurring\n`;
  const lines = entries.map(e => `${e.date},"${(e.desc||'').replace(/"/g,'""')}",${e.category},${e.type},${(e.displayAmount ?? e.originalAmount).toFixed(2)},${base},${e.recurring}`);
  const blob = new Blob([hdr + lines.join('\n')], { type:'text/csv' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='expenses_base_currency.csv'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('exportJson').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(entries,null,2)], { type:'application/json' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='expenses.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const data = JSON.parse(r.result);
      if(!Array.isArray(data)) return alert('Invalid JSON format (expected array)');
      // imported entries are assumed to be in base currency; if they include originalCurrency, keep it.
      const sanitized = data.map(item => ({
        id: item.id || uid(),
        desc: item.desc || 'Imported',
        originalAmount: Number(item.originalAmount ?? item.amount) || 0,
        originalCurrency: item.originalCurrency || baseCurrencyEl.value || 'USD',
        date: item.date || new Date().toISOString().slice(0,10),
        category: item.category || 'Uncategorized',
        type: item.type || 'expense',
        recurring: item.recurring || 'none',
        displayAmount: Number(item.displayAmount) || undefined
      }));
      entries = sanitized.concat(entries);
      log(`Imported ${sanitized.length} entries`);
      saveAll(); renderAll();
      alert('Import complete');
    }catch(err){ alert('Import failed: ' + err.message); }
  };
  r.readAsText(f); e.target.value='';
});

/* misc helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function round(n, d=2){ return Math.round(n * Math.pow(10,d))/Math.pow(10,d); }
function getLastNMonths(n){ const arr=[]; const now=new Date(); for(let i=n-1;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i, 1); arr.push(d.toISOString().slice(0,7)); } return arr; }

/* events */
document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('desc').value=''; document.getElementById('amount').value=''; document.getElementById('date').value=''; });
document.getElementById('applyFilter').addEventListener('click', ()=> renderAll());
baseCurrencyEl.addEventListener('change', async () => {
  // when base currency changes, update entryCurrency input and recompute displayAmount for every entry
  entryCurrencyInput.value = baseCurrencyEl.value;
  await renderAll();
});

/* initial */
(async function startup(){ loadAll(); // default baseCurrency will be populated by loadCurrencies.js
  // small delay so populate can run
  setTimeout(()=>{ entryCurrencyInput.value = baseCurrencyEl.value || 'USD'; },250);
  await renderAll(); renderBudgets(); renderAudit();
})();

function palette(n){ const p=['#ef4444','#f59e0b','#10b981','#3b82f6','#6366f1','#8b5cf6','#06b6d4','#f97316']; return Array.from({length:n},(_,i)=>p[i%p.length]); }
function goToDashboard(){ window.location.href = 'index.html'; }
</script>
</body>
</html>
