<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker Pro</title>
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --accent:#2b6cb0; --success:#10b981; --danger:#ef4444; --radius:10px; --muted:#6b7280;
  font-family:Arial,sans-serif;
}
body{background:var(--bg);padding:16px;margin:0;color:#0f172a;}
.card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 15px rgba(0,0,0,0.05);margin-bottom:16px;}
input,select{padding:8px;margin:4px 0;width:100%;border-radius:6px;border:1px solid #e6eef8;}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-top:8px;}
button.primary{background:var(--accent);color:#fff;}
button.ghost{background:#f1f5f9;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left;}
th{background:#fbfdff;position:sticky;top:0;}
.kpi{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
.kpi div{background:#fbfdff;padding:12px;border-radius:6px;flex:1;text-align:center;}
.alert{padding:8px;background:#fff3f2;border:1px solid #fdecea;border-radius:6px;margin-top:6px;color:#b91c1c;}
</style>
</head>
<body>

<div class="card">
<h2>Expense Tracker Pro</h2>
<div style="display:flex;gap:8px;flex-wrap:wrap">
  <div style="flex:2"><input type="text" id="desc" placeholder="Description"></div>
  <div style="flex:1"><input type="number" id="amount" placeholder="Amount"></div>
  <div style="flex:1"><select id="currency"></select></div>
  <div style="flex:1"><input type="date" id="date"></div>
  <div style="flex:1"><select id="type"><option value="expense">Expense</option><option value="income">Income</option></select></div>
  <div style="flex:1"><button class="primary" id="addBtn">Add</button></div>
</div>
</div>

<div class="card">
<div style="display:flex;gap:8px;align-items:center">
  <label>Display Currency:</label>
  <select id="displayCurrency"></select>
</div>

<div class="kpi">
  <div><strong>Total Balance</strong><p id="totalBalance">0</p></div>
  <div><strong>Total Income</strong><p id="totalIncome">0</p></div>
  <div><strong>Total Expense</strong><p id="totalExpense">0</p></div>
</div>

<div class="alert" id="budgetAlert" style="display:none;"></div>

<table>
<thead><tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Currency</th><th>Actions</th></tr></thead>
<tbody id="entriesTbody"></tbody>
</table>

<div style="margin-top:12px;display:flex;gap:8px">
<button class="ghost" id="exportCsv">Export CSV</button>
<button class="ghost" id="exportJson">Export JSON</button>
<button class="ghost" id="importBtn">Import JSON</button>
<input type="file" id="importFile" accept=".json" style="display:none;">
<button class="ghost" onclick="goToDashboard()">â¬… Back to Dashboard</button>
</div>
</div>

<script src="loadCurrencies.js"></script>
<script>
let entries = [];
const STORAGE_KEY = 'expense_tracker_pro';
const budgetThreshold = 1000; // alert if monthly expense > threshold

// populate currencies
populateCurrencyDropdown('currency');
populateCurrencyDropdown('displayCurrency');

// load saved
loadEntries();

// add entry
document.getElementById('addBtn').addEventListener('click', async ()=>{
  const desc = document.getElementById('desc').value.trim();
  let amount = parseFloat(document.getElementById('amount').value);
  const currency = document.getElementById('currency').value;
  const type = document.getElementById('type').value;
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  if(!desc || !amount || !currency){ alert("Fill all fields"); return; }
  const id = 'id_'+Math.random().toString(36).slice(2,9);
  entries.unshift({id,desc,amount,currency,type,date});
  saveEntries();
  renderEntries();
  document.getElementById('desc').value=''; document.getElementById('amount').value=''; document.getElementById('date').value='';
});

// render entries and totals
async function renderEntries(){
  const tbody = document.getElementById('entriesTbody'); tbody.innerHTML='';
  const displayCurrency = document.getElementById('displayCurrency').value || 'USD';
  const rates = await fetchRates(displayCurrency);

  let totalIncome=0, totalExpense=0;
  for(const e of entries){
    const amtDisplay = e.amount / (rates[e.currency]||1);
    if(e.type==='income') totalIncome+=amtDisplay;
    else totalExpense+=amtDisplay;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.date}</td><td>${e.desc}</td><td>${e.type}</td>
    <td>${amtDisplay.toFixed(2)}</td><td>${displayCurrency}</td>
    <td><button onclick="deleteEntry('${e.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  }

  const totalBalance = totalIncome - totalExpense;
  document.getElementById('totalBalance').innerText = `${displayCurrency} ${totalBalance.toFixed(2)}`;
  document.getElementById('totalIncome').innerText = `${displayCurrency} ${totalIncome.toFixed(2)}`;
  document.getElementById('totalExpense').innerText = `${displayCurrency} ${totalExpense.toFixed(2)}`;

  // budget alert
  const budgetAlert = document.getElementById('budgetAlert');
  if(totalExpense>budgetThreshold) { budgetAlert.style.display='block'; budgetAlert.innerText=`Warning! Monthly expenses exceed ${displayCurrency} ${budgetThreshold}`; }
  else budgetAlert.style.display='none';
}

// delete
function deleteEntry(id){ if(!confirm('Delete entry?')) return; entries = entries.filter(e=>e.id!==id); saveEntries(); renderEntries(); }

// save/load
function saveEntries(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
function loadEntries(){ entries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; renderEntries(); }

// export/import
document.getElementById('exportCsv').addEventListener('click', ()=> {
  const csv = 'date,desc,type,amount,currency\n' + entries.map(e=>`${e.date},"${e.desc}",${e.type},${e.amount},${e.currency}`).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='expenses.csv'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('exportJson').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='expenses.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload = ()=>{ try{ const data=JSON.parse(reader.result); if(Array.isArray(data)){ entries=data.concat(entries); saveEntries(); renderEntries(); alert('Imported!'); } else alert('Invalid JSON'); }catch(err){ alert(err); } };
  reader.readAsText(f); e.target.value='';
});

// currency conversion
const rateCache = {};
async function fetchRates(base='USD'){
  if(rateCache[base] && (Date.now()-rateCache[base].ts < 1000*60*15)) return rateCache[base].rates;
  try{ const res=await fetch(`https://api.exchangerate.host/latest?base=${base}`); const data=await res.json(); rateCache[base]={ts:Date.now(),rates:data.rates||{}}; return rateCache[base].rates; }catch(e){ console.warn(e); return {}; }
}

// dashboard link
function goToDashboard(){ window.location.href="index.html"; }
</script>
</body>
</html>
