<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Budget Planner — ToolNest (Pro+)</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- XLSX & jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { min-height:100vh; background: linear-gradient(135deg,#0ea5e9 0%, #7c3aed 55%, #ec4899 100%); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  .card { background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.20); }
  .muted { color: #4b5563; }
  @media (max-width:640px){ .hide-sm{ display:none } }
</style>
</head>
<body class="p-4">

<div class="max-w-6xl mx-auto space-y-6">

  <!-- Header -->
  <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-600 via-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg shadow">TN</div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white">Budget Planner — Pro+</h1>
        <p class="muted text-sm">Category ⟶ Items ⟶ Monthly plan • exports • mobile friendly</p>
      </div>
    </div>

    <div class="flex gap-2">
      <button id="backBtn" class="px-3 py-2 rounded bg-white/10 text-white hover:bg-white/20">← Dashboard</button>
      <button id="saveBtn" class="px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700">Save</button>
      <button id="resetBtn" class="px-3 py-2 rounded bg-red-500 text-white hover:bg-red-600">Reset</button>
      <button id="exportXls" class="px-3 py-2 rounded bg-white text-indigo-700 hover:bg-white/90">Excel</button>
      <button id="exportPdf" class="px-3 py-2 rounded bg-white text-indigo-700 hover:bg-white/90">PDF</button>
    </div>
  </header>

  <!-- Controls -->
  <section class="card p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="block text-sm text-gray-600">Category name</label>
        <input id="catName" class="w-full mt-1 p-2 border rounded-md" placeholder="e.g., Marketing" />
      </div>
      <div>
        <label class="block text-sm text-gray-600">Item name</label>
        <input id="itemName" class="w-full mt-1 p-2 border rounded-md" placeholder="e.g., Facebook Ads" />
      </div>
      <div class="grid grid-cols-3 gap-2">
        <div>
          <label class="block text-sm text-gray-600">Amount ($)</label>
          <input id="itemAmount" type="number" class="w-full mt-1 p-2 border rounded-md" placeholder="1000" />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Recurrence</label>
          <select id="recurrence" class="w-full mt-1 p-2 border rounded-md">
            <option value="monthly">Monthly</option>
            <option value="one-time">One-time</option>
            <option value="quarterly">Quarterly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600">Month (start)</label>
          <input id="startMonth" type="month" class="w-full mt-1 p-2 border rounded-md" />
        </div>
      </div>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="addItemBtn" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Add Item</button>
      <button id="addCategoryBtn" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Add Category Only</button>
      <div class="ml-auto text-sm muted self-center">
        <strong>Months:</strong>
        <input id="monthsCount" type="number" min="1" value="12" class="w-20 inline-block ml-2 p-1 border rounded" />
      </div>
    </div>
  </section>

  <!-- Categories + Items table -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">

    <!-- Categories list -->
    <div class="card p-3 overflow-auto" style="max-height:520px;">
      <h3 class="font-semibold text-gray-800 mb-2">Categories</h3>
      <ul id="categoriesList" class="space-y-2"></ul>
      <div class="mt-4 text-sm muted">Tap a category to view items & monthly plan.</div>
    </div>

    <!-- Items & monthly matrix -->
    <div class="card p-3 lg:col-span-2 overflow-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-800">Items & Monthly Plan</h3>
        <div class="flex gap-2 items-center">
          <label class="text-sm muted">Show</label>
          <select id="viewFilter" class="p-1 border rounded">
            <option value="all">All</option>
            <option value="one-time">One-time</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="planTable" class="w-full text-sm">
          <thead>
            <tr class="text-left text-xs text-gray-600">
              <th class="p-2">Category</th>
              <th>Item</th>
              <th>Amount</th>
              <th>Recurrence</th>
              <th>Start</th>
              <th class="hide-sm">Notes</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="mt-4">
        <h4 class="font-medium">Monthly Projection</h4>
        <canvas id="budgetChart" class="mt-2" height="160"></canvas>
      </div>
    </div>
  </section>

  <!-- Summary -->
  <section class="card p-4">
    <h3 class="text-lg font-semibold">Summary & Suggestions</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
      <div class="p-3 bg-indigo-50 rounded">
        <div class="text-sm muted">Total Budget (all months)</div>
        <div id="totalBudget" class="text-xl font-semibold text-indigo-700">$0.00</div>
      </div>
      <div class="p-3 bg-green-50 rounded">
        <div class="text-sm muted">Average monthly spend</div>
        <div id="avgMonthly" class="text-xl font-semibold text-green-700">$0.00</div>
      </div>
      <div class="p-3 bg-yellow-50 rounded">
        <div class="text-sm muted">Suggestions</div>
        <div id="suggestions" class="mt-2 text-sm muted">No suggestions yet.</div>
      </div>
    </div>
  </section>

</div>

<script>
/* Budget Planner Pro+ — single-file
   - categories[]: {id, name, items: [{id, name, amount, recurrence, startMonth, notes}]}
   - monthly projection for N months
   - Chart.js stacked bar for monthly totals per category
   - localStorage save/load
*/

const STORAGE_KEY = 'tn_budget_pro_v1';
let categories = []; // load from storage
let chart = null;

// DOM
const catName = document.getElementById('catName');
const itemName = document.getElementById('itemName');
const itemAmount = document.getElementById('itemAmount');
const recurrence = document.getElementById('recurrence');
const startMonth = document.getElementById('startMonth');
const addItemBtn = document.getElementById('addItemBtn');
const addCategoryBtn = document.getElementById('addCategoryBtn');
const monthsCount = document.getElementById('monthsCount');
const categoriesList = document.getElementById('categoriesList');
const itemsBody = document.getElementById('itemsBody');
const viewFilter = document.getElementById('viewFilter');
const exportXls = document.getElementById('exportXls');
const exportPdf = document.getElementById('exportPdf');
const saveBtn = document.getElementById('saveBtn');
const resetBtn = document.getElementById('resetBtn');
const backBtn = document.getElementById('backBtn');

const totalBudgetEl = document.getElementById('totalBudget');
const avgMonthlyEl = document.getElementById('avgMonthly');
const suggestionsEl = document.getElementById('suggestions');

// helpers
const uid = ()=> Math.random().toString(36).slice(2,9);
const monthLabelsFrom = (start, count)=>{
  const out = [];
  const startDate = start ? new Date(start + '-01') : new Date();
  for(let i=0;i<count;i++){
    const d = new Date(startDate.getFullYear(), startDate.getMonth()+i, 1);
    out.push(d.toLocaleString(undefined,{month:'short',year:'2-digit'}));
  }
  return out;
};
const recurrenceApplies = (rec, start, monthIndex, startRefMonthIndex)=>{
  // monthIndex relative to startRefMonthIndex (0..N-1)
  if(rec === 'monthly') return true;
  if(rec === 'one-time') return monthIndex === 0;
  if(rec === 'quarterly') return monthIndex % 3 === 0;
  if(rec === 'annual') return monthIndex % 12 === 0;
  return false;
};

// load / save
function loadStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){ categories = JSON.parse(raw); }
    else { categories = []; }
  }catch(e){ categories = []; }
}
function saveStorage(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(categories)); showToast('Saved locally'); }

// UI
function showToast(msg, ms=1600){
  const t = document.createElement('div');
  t.innerText = msg;
  t.className = 'fixed right-4 top-4 bg-black text-white px-3 py-2 rounded shadow';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), ms);
}

// render categories list
function renderCategories(){
  categoriesList.innerHTML = '';
  categories.forEach((c, idx)=>{
    const li = document.createElement('li');
    li.className = 'p-2 rounded hover:bg-indigo-50 cursor-pointer flex justify-between items-center';
    li.innerHTML = `<div><strong>${c.name}</strong><div class="text-xs muted">${c.items.length} items</div></div>
                    <div class="flex gap-2"><button data-idx="${idx}" class="edit-cat text-sm text-blue-600">Edit</button><button data-idx="${idx}" class="del-cat text-sm text-red-600">Del</button></div>`;
    categoriesList.appendChild(li);

    li.addEventListener('click', (e)=>{
      if(e.target.classList.contains('edit-cat')) return;
      // open category (render items below)
      renderItemsTable(idx);
    });

    li.querySelector('.del-cat').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(confirm('Delete category and its items?')){ categories.splice(idx,1); renderCategories(); renderItemsTable(); saveStorage(); generateProjection(); }
    });

    li.querySelector('.edit-cat').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const newName = prompt('Edit category name', c.name);
      if(newName){ c.name = newName; renderCategories(); saveStorage(); }
    });
  });
}

// render items table (for all categories combined or per category)
function renderItemsTable(catIndex = null){
  itemsBody.innerHTML = '';
  const rows = [];
  categories.forEach((c, cIdx)=>{
    if(catIndex !== null && catIndex !== cIdx) return;
    c.items.forEach(it => {
      rows.push({cat: c.name, catIdx: cIdx, item: it});
    });
  });

  // apply view filter
  const filter = viewFilter.value;
  const filtered = rows.filter(r => filter === 'all' ? true : r.item.recurrence === filter);

  filtered.forEach((r, i)=>{
    const it = r.item;
    const tr = document.createElement('tr');
    tr.className = 'border-b';
    tr.innerHTML = `
      <td class="p-2">${r.cat}</td>
      <td class="p-2">${it.name}</td>
      <td class="p-2">$${it.amount.toFixed(2)}</td>
      <td class="p-2">${it.recurrence}</td>
      <td class="p-2">${it.startMonth || '-'}</td>
      <td class="p-2 hide-sm">${it.notes || '-'}</td>
      <td class="p-2">
        <button data-cat="${r.catIdx}" data-id="${it.id}" class="edit-item text-sm text-blue-600">Edit</button>
        <button data-cat="${r.catIdx}" data-id="${it.id}" class="del-item text-sm text-red-600 ml-2">Del</button>
      </td>
    `;
    itemsBody.appendChild(tr);

    tr.querySelector('.del-item').addEventListener('click', ()=>{
      if(confirm('Delete item?')){ categories[r.catIdx].items = categories[r.catIdx].items.filter(x=>x.id!==it.id); renderItemsTable(); renderCategories(); saveStorage(); generateProjection(); }
    });

    tr.querySelector('.edit-item').addEventListener('click', ()=>{
      // prefill the top controls for easier edit
      catName.value = r.cat;
      itemName.value = it.name;
      itemAmount.value = it.amount;
      recurrence.value = it.recurrence;
      startMonth.value = it.startMonth || '';
      monthsCount.value = monthsCount.value; // no change
      // remove original to re-add on save
      categories[r.catIdx].items = categories[r.catIdx].items.filter(x=>x.id!==it.id);
      renderCategories();
      renderItemsTable();
      saveStorage();
    });
  });
}

// add category only
addCategoryBtn.addEventListener('click', ()=>{
  const name = catName.value.trim();
  if(!name) return alert('Enter category name');
  categories.push({ id: uid(), name, items: [] });
  catName.value = '';
  renderCategories(); saveStorage();
});

// add item
addItemBtn.addEventListener('click', ()=>{
  const cName = catName.value.trim(); const iName = itemName.value.trim();
  const amount = parseFloat(itemAmount.value); const rec = recurrence.value; const sm = startMonth.value;
  if(!cName || !iName || isNaN(amount)) return alert('Please enter category, item name and numeric amount.');

  // find or create category
  let cat = categories.find(c => c.name.toLowerCase()===cName.toLowerCase());
  if(!cat){
    cat = { id: uid(), name: cName, items: [] };
    categories.push(cat);
  }
  const item = { id: uid(), name: iName, amount: amount, recurrence: rec, startMonth: sm, notes: '', created: Date.now() };
  cat.items.push(item);

  // clear inputs
  itemName.value=''; itemAmount.value=''; startMonth.value=''; catName.value='';

  renderCategories(); renderItemsTable(); saveStorage(); generateProjection();
});

// projection: build monthly totals per category
function generateProjection(){
  const months = parseInt(monthsCount.value) || 12;
  // find global start month - earliest startMonth among items or today
  let earliest = null;
  categories.forEach(c=>{
    c.items.forEach(it=>{
      if(it.startMonth){
        const d = new Date(it.startMonth + '-01');
        if(!earliest || d < earliest) earliest = d;
      }
    });
  });
  const startRef = earliest ? new Date(earliest.getFullYear(), earliest.getMonth(), 1) : new Date();
  const monthLabels = monthLabelsFrom(startRef.toISOString().slice(0,7), months);

  // prepare series per category
  const datasets = [];
  let totalAll = 0;
  categories.forEach((c, idx)=>{
    const monthly = Array.from({length: months}, ()=>0);
    c.items.forEach(it=>{
      // item's start index
      const itStart = it.startMonth ? (new Date(it.startMonth + '-01').getFullYear() - startRef.getFullYear())*12 + (new Date(it.startMonth + '-01').getMonth() - startRef.getMonth()) : 0;
      for(let m=0;m<months;m++){
        const rel = m - itStart;
        if(rel < 0) continue;
        if(recurrenceApplies(it.recurrence, it.startMonth, rel, itStart)){
          monthly[m] += it.amount;
          totalAll += it.amount;
        }
      }
    });
    datasets.push({ label: c.name, data: monthly, backgroundColor: randomColor(idx) });
  });

  // update chart
  const ctx = document.getElementById('budgetChart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: monthLabels, datasets },
    options: {
      plugins:{ legend:{ position:'bottom' } },
      responsive:true, maintainAspectRatio:false,
      scales: { x:{ stacked:true }, y:{ stacked:true, ticks:{ callback: v=> '$' + v.toLocaleString() } } }
    }
  });

  // update totals & suggestions
  const avgMonthly = totalAll / months;
  totalBudgetEl.innerText = '$' + totalAll.toFixed(2);
  avgMonthlyEl.innerText = '$' + avgMonthly.toFixed(2);

  // suggestions: simple rules
  const sugg = [];
  // overspend categories: find categories where total yearly > avgMonthly*... or threshold
  categories.forEach((c,i)=>{
    const catTotal = datasets[i].data.reduce((a,b)=>a+b,0);
    if(catTotal > avgMonthly*0.6) sugg.push(`${c.name}: relatively high budget (${catTotal.toFixed(0)})`);
  });
  if(sugg.length===0) suggestionsEl.innerText = 'All categories look balanced.';
  else suggestionsEl.innerHTML = sugg.map(s=>`• ${s}`).join('<br>');
}

// small color generator
function randomColor(i){
  const palette = ['#60a5fa','#34d399','#f97316','#f472b6','#a78bfa','#f59e0b','#06b6d4','#fb7185','#fda4af','#7dd3fc'];
  return palette[i % palette.length];
}

// exports
exportXls.addEventListener('click', ()=>{
  // collect rows
  const rows = [];
  categories.forEach(c=>{
    c.items.forEach(it=>{
      rows.push({ category: c.name, item: it.name, amount: it.amount, recurrence: it.recurrence, start: it.startMonth || '', notes: it.notes || '' });
    });
  });
  if(rows.length===0) return alert('No data to export');
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Budget');
  XLSX.writeFile(wb, 'budget_plan.xlsx');
});

exportPdf.addEventListener('click', async ()=>{
  if(!chart) return alert('Generate projection first');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
  doc.setFontSize(16); doc.text('Budget Plan Report', 40, 40);
  const img = chart.toBase64Image();
  doc.addImage(img, 'PNG', 40, 70, 700, 240);
  // list top items
  let y = 330;
  doc.setFontSize(10);
  categories.forEach(c=>{
    c.items.forEach(it=>{
      doc.text(`${c.name} • ${it.name} • $${it.amount} • ${it.recurrence} • ${it.startMonth || '-'}`, 40, y);
      y += 12;
      if(y>520){ doc.addPage(); y = 40; }
    });
  });
  doc.save('budget_plan.pdf');
});

// save/load/reset/back
saveBtn.addEventListener('click', ()=>{ saveStorage(); });
resetBtn.addEventListener('click', ()=>{ if(confirm('Reset all budget data?')){ categories = []; saveStorage(); renderCategories(); renderItemsTable(); if(chart){ chart.destroy(); chart=null; } totalBudgetEl.innerText = '$0.00'; avgMonthlyEl.innerText = '$0.00'; suggestionsEl.innerText = 'No suggestions yet.'; }} );
backBtn.addEventListener('click', ()=>{ window.location.href = 'index.html'; });

// view filter change
viewFilter.addEventListener('change', ()=> renderItemsTable());

// initialize
loadStorage();
renderCategories();
renderItemsTable();
generateProjection();

// re-generate when months changed
monthsCount.addEventListener('change', generateProjection);

// simple auto-save every 10s
setInterval(()=>{ saveStorage(); }, 10000);

</script>
</body>
</html>
