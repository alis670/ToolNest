<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Employee Attendance & Salary Tracker — Final</title>
<style>
:root{
  --bg:#f6f8fb; --card:#fff; --muted:#6b7280; --accent:#2563eb;
  --success:#10b981; --danger:#ef4444; --warn:#f59e0b; --radius:12px;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0b1220;padding:16px}
.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:20px}
small.muted{color:var(--muted)}
.input, select, button{font-family:inherit}
.input, select{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:#fff;width:100%}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
.flex{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;font-weight:700}
.btn.ghost{background:#f1f5f9;border:1px solid #e6eef8}
.btn.warn{background:var(--warn);color:#fff}
.btn.danger{background:var(--danger);color:#fff}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.calendar-wrap{display:flex;gap:16px;flex-wrap:wrap}
.calendar{flex:1;min-width:320px}
.controls{display:flex;gap:8px;align-items:center}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
.cell{border:1px solid #eef2f7;border-radius:8px;min-height:82px;padding:8px;background:#fff;display:flex;flex-direction:column}
.cell .date{font-size:13px;margin-bottom:6px;color:#374151}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
.badge.present{background:var(--success);color:#fff}
.badge.absent{background:var(--danger);color:#fff}
.badge.late{background:var(--warn);color:#000}
.empty{background:transparent;border:0}
.employee-list{display:flex;flex-direction:column;gap:6px}
.emp-item{padding:8px;border-radius:8px;border:1px solid #eef2f7;background:#fff;cursor:pointer}
.emp-item.active{outline:2px solid rgba(37,99,235,0.12)}
.kv{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f1f5f9}
.footer-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.setting-row{display:flex;gap:8px;align-items:center;margin-top:8px}
@media(max-width:1024px){.container{grid-template-columns:1fr} .calendar-wrap{flex-direction:column}}
</style>
</head>
<body>

<div class="container">

  <!-- MAIN -->
  <div class="card" id="mainCard">
    <div class="header">
      <div>
        <h1>Employee Attendance & Salary Tracker (Final)</h1>
        <small class="muted">Hybrid deductions (absent = full day cut; custom late rule) — responsive SaaS layout.</small>
      </div>

      <div style="min-width:220px">
        <label style="display:block;font-size:13px;margin-bottom:6px">Select Month</label>
        <input id="month" type="month" class="input">
      </div>
    </div>

    <!-- Employee creation / salary settings -->
    <div style="margin-top:12px" class="row">
      <div>
        <label>Employee Name</label>
        <input id="empName" class="input" placeholder="John Doe">
      </div>
      <div>
        <label>Department</label>
        <input id="empDept" class="input" placeholder="Sales">
      </div>
      <div>
        <label>Salary Type</label>
        <select id="empType" class="input">
          <option value="monthly">Monthly</option>
          <option value="weekly">Weekly</option>
          <option value="hourly">Hourly</option>
        </select>
      </div>
      <div>
        <label>Currency + Base Salary</label>
        <div style="display:flex;gap:8px">
          <select id="empCurrency" class="input" style="max-width:120px"></select>
          <input id="empBase" type="number" class="input" placeholder="Base salary" style="flex:1">
        </div>
      </div>
      <div>
        <label>Overtime rate (per hour)</label>
        <input id="empOvertime" type="number" class="input" placeholder="Overtime rate">
      </div>
      <div>
        <label>Bonus</label>
        <input id="empBonus" type="number" class="input" placeholder="Bonus">
      </div>
      <div style="display:flex;align-items:end">
        <button id="addEmp" class="btn primary">Add Employee</button>
      </div>
    </div>

    <!-- Deduction Settings (Hybrid - custom) -->
    <div style="margin-top:12px" class="card">
      <h3 style="margin:0 0 8px">Deduction Settings — Hybrid (Custom)</h3>
      <div class="setting-row">
        <div style="min-width:260px">
          <label>Late deduction rule</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="lateMinutes" type="number" class="input" style="width:120px" placeholder="minutes per step">
            <input id="lateAmount" type="number" class="input" style="width:160px" placeholder="cut amount (currency)">
            <div style="font-size:13px;color:var(--muted)">Apply: (totalLateMinutes / minutes) × amount</div>
          </div>
        </div>

        <div style="min-width:220px">
          <label>Absent deduction rule</label>
          <div style="font-size:14px;color:var(--muted);margin-top:6px">Absent = full day salary cut (base / working days)</div>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="saveRules" class="btn ghost">Save Rules</button>
          <button id="resetRules" class="btn ghost">Reset</button>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-row" style="margin-top:12px">
      <div style="min-width:220px">
        <select id="filterEmp" class="input"><option value="">Filter by employee</option></select>
      </div>
      <div style="min-width:160px">
        <input id="filterDept" class="input" placeholder="Filter by department">
      </div>
      <div style="flex:1"></div>
      <div style="display:flex;gap:8px">
        <button id="clearFilters" class="btn ghost">Clear</button>
      </div>
    </div>

    <!-- Calendar & Salary Summary -->
    <div class="calendar-wrap" style="margin-top:12px">
      <div class="calendar card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong id="monthLabel">Month</strong>
          <div style="display:flex;gap:8px">
            <select id="compactEmp" class="input" style="min-width:220px"></select>
            <button id="refresh" class="btn ghost">Refresh</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px;font-weight:600;color:var(--muted)">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>

        <div id="grid" class="calendar-grid"></div>

        <div class="footer-actions">
          <button id="downloadAllCsv" class="btn ghost">Download CSV</button>
          <button id="downloadAllJson" class="btn ghost">Download JSON</button>
        </div>
      </div>

      <!-- Right sidebar: salary breakdown -->
      <div class="card" style="min-width:300px">
        <h3>Salary Breakdown</h3>
        <div id="salaryBox">
          <div class="kv"><div>Employee</div><div id="sName">-</div></div>
          <div class="kv"><div>Dept</div><div id="sDept">-</div></div>
          <div class="kv"><div>Type</div><div id="sType">-</div></div>
          <div class="kv"><div>Base</div><div id="sBase">-</div></div>
          <div class="kv"><div>Bonus</div><div id="sBonus">-</div></div>
          <div class="kv"><div>Overtime Pay</div><div id="sOver">-</div></div>
          <div class="kv"><div>Late Deduction</div><div id="sLate">-</div></div>
          <div class="kv"><div>Absent Deduction</div><div id="sAbsent">-</div></div>
          <div class="kv"><div><strong>Total Payable</strong></div><div id="sTotal"><strong>-</strong></div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="printSlip" class="btn primary">Print Slip</button>
          <button id="downloadSlipCsv" class="btn ghost">Download CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="card">
    <h3>Employees</h3>
    <div id="list" class="employee-list" style="margin-top:8px"></div>

    <div style="margin-top:12px">
      <h4 style="margin:6px 0">Quick</h4>
      <div style="display:flex;gap:8px">
        <button id="clearAll" class="btn danger">Clear All</button>
        <button id="exportAll" class="btn ghost">Export All</button>
      </div>
    </div>
  </div>
</div>

<!-- optional currencies loader (user supplies) -->
<script src="loadCurrencies.js"></script>

<script>
/* FULL final client-side file implementing:
   - Employee add (base salary + currency)
   - Month calendar rendering
   - Mark Present / Absent / Late (enter minutes)
   - Custom late-rule (minutes -> cut amount)
   - Absent deduction full-day
   - Overtime, bonus, final salary calc
   - Downloads & print
*/

// state & storage keys
const KEY = 'et_salary_attendance_v1';
let state = JSON.parse(localStorage.getItem(KEY) || '{"emps":[],"rules":{ "lateMinutes":10,"lateAmount":50 }}');

// dom refs
const monthEl = document.getElementById('month');
const gridEl = document.getElementById('grid');
const compactEmp = document.getElementById('compactEmp');
const listEl = document.getElementById('list');
const filterEmp = document.getElementById('filterEmp');

const lateMinutesEl = document.getElementById('lateMinutes');
const lateAmountEl = document.getElementById('lateAmount');

// initialize month
monthEl.value = new Date().toISOString().slice(0,7);
let selectedMonth = monthEl.value;
monthEl.addEventListener('change', ()=>{ selectedMonth = monthEl.value; render(); });

// try populate currencies
function populateCurrencyFallback(el){
  ['USD','EUR','GBP','PKR','INR'].forEach(c=>{ const o=document.createElement('option'); o.value=c; o.text=c; el.appendChild(o); });
}
if(typeof populateCurrencyDropdown === 'function'){
  try{ populateCurrencyDropdown('empCurrency'); } catch(e){ populateCurrencyFallback(document.getElementById('empCurrency')); }
} else populateCurrencyFallback(document.getElementById('empCurrency'));

// apply saved rules
lateMinutesEl.value = state.rules.lateMinutes || 10;
lateAmountEl.value = state.rules.lateAmount || 50;

// helpers
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }

// add employee
document.getElementById('addEmp').addEventListener('click', ()=>{
  const name = document.getElementById('empName').value.trim();
  if(!name) return alert('Enter name');
  const emp = {
    id: uid(),
    name,
    dept: document.getElementById('empDept').value.trim(),
    type: document.getElementById('empType').value,
    currency: document.getElementById('empCurrency').value || 'USD',
    base: Number(document.getElementById('empBase').value) || 0,
    overtimeRate: Number(document.getElementById('empOvertime').value) || 0,
    bonus: Number(document.getElementById('empBonus').value) || 0,
    attendance: {} // date-> {status:'present'|'absent'|'late', minutes, overtime}
  };
  state.emps.push(emp);
  save(); clearEmpForm(); render();
});

function clearEmpForm(){
  document.getElementById('empName').value=''; document.getElementById('empDept').value=''; document.getElementById('empBase').value=''; document.getElementById('empOvertime').value=''; document.getElementById('empBonus').value='';
}

// save rules
document.getElementById('saveRules').addEventListener('click', ()=>{
  const m = Number(lateMinutesEl.value) || 1;
  const a = Number(lateAmountEl.value) || 0;
  state.rules.lateMinutes = Math.max(1,m);
  state.rules.lateAmount = a;
  save(); alert('Rules saved');
});

// reset rules
document.getElementById('resetRules').addEventListener('click', ()=>{
  state.rules = { lateMinutes:10, lateAmount:50 };
  lateMinutesEl.value = state.rules.lateMinutes; lateAmountEl.value = state.rules.lateAmount;
  save(); alert('Rules reset');
});

// filter & clear
document.getElementById('clearFilters').addEventListener('click', ()=>{
  filterEmp.value=''; document.getElementById('filterDept').value=''; render();
});

// downloads
document.getElementById('downloadAllCsv').addEventListener('click', downloadAllCsv);
document.getElementById('downloadAllJson').addEventListener('click', downloadAllJson);
document.getElementById('downloadSlipCsv').addEventListener('click', downloadSlipCsv);
document.getElementById('printSlip').addEventListener('click', printSlip);
document.getElementById('exportAll').addEventListener('click', downloadAllJson);
document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('Clear everything?')){ state = { emps: [], rules: state.rules }; save(); render(); } });

// core rendering
function render(){
  selectedMonth = monthEl.value || selectedMonth;
  document.getElementById('monthLabel').textContent = new Date(selectedMonth+'-01').toLocaleString(undefined,{month:'long',year:'numeric'});
  renderList();
  renderCompact();
  renderGrid();
  renderSalaryBox();
  save();
}

function renderList(){
  listEl.innerHTML=''; filterEmp.innerHTML='<option value=\"\">Filter by employee</option>';
  state.emps.forEach(emp=>{
    const it = document.createElement('div'); it.className='emp-item'; it.dataset.id=emp.id;
    it.innerHTML = `<strong>${emp.name}</strong><div style="font-size:12px;color:var(--muted)">${emp.dept}</div>`;
    it.addEventListener('click', ()=>{ // toggle select
      const was = emp._selected;
      state.emps.forEach(e=>e._selected=false);
      emp._selected = !was;
      render();
    });
    if(emp._selected) it.classList.add('active');
    listEl.appendChild(it);

    const o = document.createElement('option'); o.value = emp.id; o.textContent = emp.name;
    filterEmp.appendChild(o);
  });
}

function renderCompact(){
  compactEmp.innerHTML = '<option value=\"\">Select employee</option>';
  state.emps.forEach(emp=>{ const o = document.createElement('option'); o.value=emp.id; o.text=emp.name; compactEmp.appendChild(o); });
  compactEmp.addEventListener('change', ()=>{ const id = compactEmp.value || null; state.emps.forEach(e=>e._selected = (e.id===id)); render(); });
  // filter select
  const f = document.getElementById('filterEmp'); if(f){ f.innerHTML = '<option value=\"\">Filter by employee</option>'; state.emps.forEach(emp=>{ const o=document.createElement('option'); o.value=emp.id; o.text=emp.name; f.appendChild(o); }); }
}

function renderGrid(){
  gridEl.innerHTML=''; if(!selectedMonth) return;
  const [Y, M] = selectedMonth.split('-').map(Number);
  const firstDay = new Date(Y, M-1, 1).getDay();
  const days = new Date(Y, M, 0).getDate();

  // empties
  for(let i=0;i<firstDay;i++){ const e = document.createElement('div'); e.className='empty'; gridEl.appendChild(e); }

  for(let d=1; d<=days; d++){
    const date = `${selectedMonth}-${String(d).padStart(2,'0')}`;
    const cell = document.createElement('div'); cell.className='cell'; cell.dataset.date = date;
    const dateDiv = document.createElement('div'); dateDiv.className='date'; dateDiv.textContent = d;
    cell.appendChild(dateDiv);

    const selectedEmp = state.emps.find(e=>e._selected) || null;
    if(!selectedEmp){
      const hint = document.createElement('div'); hint.style.color='var(--muted)'; hint.textContent = 'Select an employee to mark attendance';
      cell.appendChild(hint);
    } else {
      const att = selectedEmp.attendance[date];
      if(att){
        const span = document.createElement('div'); span.className = 'badge ' + (att.status==='present'?'present': att.status==='absent'?'absent':'late');
        let label = att.status.charAt(0).toUpperCase()+att.status.slice(1);
        if(att.status==='late' && att.minutes) label += ` (${att.minutes}m)`;
        span.textContent = label;
        cell.appendChild(span);

        // small actions to change
        const change = document.createElement('div'); change.style.marginTop='8px'; change.style.display='flex'; change.style.gap='6px';
        const eBtn = document.createElement('button'); eBtn.className='btn ghost'; eBtn.textContent='Edit'; eBtn.addEventListener('click', ()=>editAttendance(selectedEmp, date));
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='Remove'; delBtn.addEventListener('click', ()=>{ delete selectedEmp.attendance[date]; save(); render(); });
        change.appendChild(eBtn); change.appendChild(delBtn); cell.appendChild(change);
      } else {
        // buttons: Present / Absent / Late
        const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='6px'; wrap.style.flexWrap='wrap'; wrap.style.marginTop='auto';
        const p = document.createElement('button'); p.className='btn ghost'; p.textContent='Present'; p.addEventListener('click', ()=>{ setAttendance(selectedEmp.id, date, 'present'); });
        const a = document.createElement('button'); a.className='btn ghost'; a.textContent='Absent'; a.addEventListener('click', ()=>{ setAttendance(selectedEmp.id, date, 'absent'); });
        const l = document.createElement('button'); l.className='btn ghost'; l.textContent='Late'; l.addEventListener('click', ()=>{ const mins = prompt('Minutes late? (numeric)'); const m = Number(mins)||0; const ot = prompt('Overtime hours (optional)'); const o = Number(ot)||0; setAttendance(selectedEmp.id, date, 'late', m, o); });
        wrap.appendChild(p); wrap.appendChild(a); wrap.appendChild(l);
        cell.appendChild(wrap);
      }
    }

    gridEl.appendChild(cell);
  }
}

function setAttendance(empId, date, status, minutes=0, overtime=0){
  const emp = state.emps.find(e=>e.id===empId); if(!emp) return;
  emp.attendance = emp.attendance || {};
  emp.attendance[date] = { status, minutes: minutes||0, overtime: overtime||0 };
  save(); render();
}

function editAttendance(emp, date){
  const a = emp.attendance[date]; if(!a) return;
  const status = prompt('Status (present/absent/late)', a.status) || a.status;
  let minutes = a.minutes || 0;
  if(status==='late') minutes = Number(prompt('Minutes late', a.minutes||0) || a.minutes || 0);
  emp.attendance[date] = { status, minutes };
  save(); render();
}

// salary calc (hybrid)
function calcFor(emp, month){
  const [Y,M] = month.split('-').map(Number);
  const daysInMonth = new Date(Y, M, 0).getDate();

  // working days (mon-fri)
  let workingDays = 0;
  for(let d=1; d<=daysInMonth; d++){
    const wd = new Date(Y, M-1, d).getDay();
    if(wd!==0 && wd!==6) workingDays++;
  }
  // count attendance
  let present=0, absent=0, lateMinutes=0, overtimeHours=0;
  for(let d=1; d<=daysInMonth; d++){
    const date = `${month}-${String(d).padStart(2,'0')}`;
    const a = emp.attendance && emp.attendance[date];
    if(!a) continue;
    if(a.status==='present') present++;
    if(a.status==='absent') absent++;
    if(a.status==='late'){ lateMinutes += (a.minutes||0); present++; }
    if(a.overtime) overtimeHours += (a.overtime||0);
  }

  // base pay
  const base = Number(emp.base) || 0;
  let overtimePay = (Number(emp.overtimeRate)||0) * overtimeHours;
  let bonus = Number(emp.bonus)||0;

  // absent deduction = full day(s)
  let absentDeduction = 0;
  if(emp.type==='hourly'){
    // difficult to compute hourly absent without hours; skip absent deduction for hourly employees
    absentDeduction = 0;
  } else if(emp.type==='weekly'){
    const weekly = base; const daily = weekly/5; absentDeduction = daily * absent;
  } else { // monthly
    const daily = base / Math.max(1, workingDays); absentDeduction = daily * absent;
  }

  // late deduction: using state.rules.lateMinutes & lateAmount
  const step = Number(state.rules.lateMinutes) || 1;
  const cut = Number(state.rules.lateAmount) || 0;
  const lateDeduction = Math.floor(lateMinutes / step) * cut;

  // final
  const total = (emp.type==='hourly' ? base : base) + overtimePay + bonus - absentDeduction - lateDeduction;
  return {
    currency: emp.currency || 'USD',
    base, overtimePay, bonus, absentDeduction, lateDeduction, total, present, absent, lateMinutes, overtimeHours
  };
}

function renderSalaryBox(){
  const emp = state.emps.find(e=>e._selected) || null;
  if(!emp){
    document.getElementById('sName').textContent='-'; document.getElementById('sDept').textContent='-';
    document.getElementById('sType').textContent='-'; document.getElementById('sBase').textContent='-';
    document.getElementById('sBonus').textContent='-'; document.getElementById('sOver').textContent='-';
    document.getElementById('sLate').textContent='-'; document.getElementById('sAbsent').textContent='-';
    document.getElementById('sTotal').textContent='-'; return;
  }
  const out = calcFor(emp, selectedMonth);
  const fmt = v => (out.currency||'') + ' ' + Number(v||0).toFixed(2);
  document.getElementById('sName').textContent = emp.name;
  document.getElementById('sDept').textContent = emp.dept || '-';
  document.getElementById('sType').textContent = emp.type;
  document.getElementById('sBase').textContent = fmt(out.base);
  document.getElementById('sBonus').textContent = fmt(out.bonus);
  document.getElementById('sOver').textContent = fmt(out.overtimePay);
  document.getElementById('sLate').textContent = '-'+fmt(out.lateDeduction);
  document.getElementById('sAbsent').textContent = '-'+fmt(out.absentDeduction);
  document.getElementById('sTotal').textContent = fmt(out.total);
}

// downloads
function downloadAllCsv(){
  const rows = [['empId','empName','date','status','minutes','overtime']];
  state.emps.forEach(emp=>{
    Object.entries(emp.attendance||{}).forEach(([date,a])=>{
      rows.push([emp.id, emp.name, date, a.status, a.minutes||0, a.overtime||0]);
    });
  });
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='attendance.csv'; a.click(); URL.revokeObjectURL(url);
}
function downloadAllJson(){ const j = JSON.stringify(state.emps, null, 2); const blob=new Blob([j],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='attendance.json'; a.click(); URL.revokeObjectURL(url); }

function downloadSlipCsv(){
  const emp = state.emps.find(e=>e._selected); if(!emp) return alert('Select an employee');
  const out = calcFor(emp, selectedMonth);
  const rows = [['label','value'], ['Employee', emp.name], ['Period', selectedMonth], ['Base', out.base], ['Overtime', out.overtimePay], ['Bonus', out.bonus], ['LateDeduction', out.lateDeduction], ['AbsentDeduction', out.absentDeduction], ['Total', out.total]];
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
  const blob = new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`salary_${emp.name}.csv`; a.click(); URL.revokeObjectURL(url);
}

function printSlip(){
  const emp = state.emps.find(e=>e._selected); if(!emp) return alert('Select an employee');
  const out = calcFor(emp, selectedMonth);
  const html = `<div style="font-family:Arial;padding:20px"><h2>Salary Slip</h2><div>Employee: ${emp.name}</div><div>Period: ${selectedMonth}</div><div>Base: ${emp.currency} ${out.base.toFixed(2)}</div><div>Overtime: ${emp.currency} ${out.overtimePay.toFixed(2)}</div><div>Bonus: ${emp.currency} ${out.bonus.toFixed(2)}</div><div>Late Deduction: ${emp.currency} ${out.lateDeduction.toFixed(2)}</div><div>Absent Deduction: ${emp.currency} ${out.absentDeduction.toFixed(2)}</div><h3>Total: ${emp.currency} ${out.total.toFixed(2)}</h3></div>`;
  const w = window.open('', '_blank'); w.document.write(html); w.document.close(); w.print();
}

// init: load saved (state already set), ensure rules exist
if(!state.rules) state.rules = { lateMinutes:10, lateAmount:50 };
state.rules.lateMinutes = state.rules.lateMinutes || 10; state.rules.lateAmount = state.rules.lateAmount || 50;
lateMinutesEl.value = state.rules.lateMinutes; lateAmountEl.value = state.rules.lateAmount;

// when save rules clicked, update state.rules from fields
document.getElementById('saveRules').addEventListener('click', ()=>{ state.rules.lateMinutes = Number(lateMinutesEl.value)||1; state.rules.lateAmount = Number(lateAmountEl.value)||0; save(); alert('Saved'); });

// keep state.rules in sync for calculations
setInterval(()=>{ state.rules.lateMinutes = Number(lateMinutesEl.value)||state.rules.lateMinutes; state.rules.lateAmount = Number(lateAmountEl.value)||state.rules.lateAmount; save(); }, 2000);

// small refresh
document.getElementById('refresh').addEventListener('click', ()=>render());

// initial render
render();

</script>
</body>
</html>
